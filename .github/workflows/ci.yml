name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  DEVELOPER_DIR: /Applications/Xcode_15.0.app/Contents/Developer

jobs:
  lint:
    name: SwiftLint
    runs-on: macos-14
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install SwiftLint
        run: brew install swiftlint

      - name: Run SwiftLint
        run: swiftlint lint --strict

  test-ios:
    name: Test iOS
    runs-on: macos-14
    needs: lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_15.0.app/Contents/Developer

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Build and test iOS
        run: |
          xcodebuild clean test \
            -scheme NoteTaker \
            -sdk iphonesimulator \
            -destination 'platform=iOS Simulator,name=iPhone 15 Pro,OS=17.0' \
            -enableCodeCoverage YES \
            -derivedDataPath DerivedData \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            ONLY_ACTIVE_ARCH=NO

      - name: Generate code coverage report
        run: |
          xcrun xccov view --report --json DerivedData/Logs/Test/*.xcresult > coverage.json

      - name: Check code coverage
        run: |
          coverage=$(xcrun xccov view --report DerivedData/Logs/Test/*.xcresult | grep "NoteTaker.app" | awk '{print $4}' | sed 's/%//')
          echo "Code coverage: ${coverage}%"
          if (( $(echo "$coverage < 70" | bc -l) )); then
            echo "ERROR: Code coverage is below 70% (got ${coverage}%)"
            exit 1
          fi

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ios-coverage
          path: coverage.json

  test-macos:
    name: Test macOS
    runs-on: macos-14
    needs: lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_15.0.app/Contents/Developer

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Build and test macOS
        run: |
          xcodebuild clean test \
            -scheme NoteTaker \
            -sdk macosx \
            -destination 'platform=macOS' \
            -enableCodeCoverage YES \
            -derivedDataPath DerivedData \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            ONLY_ACTIVE_ARCH=NO

      - name: Generate code coverage report
        run: |
          xcrun xccov view --report --json DerivedData/Logs/Test/*.xcresult > coverage-macos.json

      - name: Check code coverage
        run: |
          coverage=$(xcrun xccov view --report DerivedData/Logs/Test/*.xcresult | grep "NoteTaker.app" | awk '{print $4}' | sed 's/%//')
          echo "Code coverage: ${coverage}%"
          if (( $(echo "$coverage < 70" | bc -l) )); then
            echo "ERROR: Code coverage is below 70% (got ${coverage}%)"
            exit 1
          fi

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: macos-coverage
          path: coverage-macos.json

  build-ios:
    name: Build iOS Release
    runs-on: macos-14
    needs: [test-ios, test-macos]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_15.0.app/Contents/Developer

      - name: Build iOS Release
        run: |
          xcodebuild clean build \
            -scheme NoteTaker \
            -sdk iphonesimulator \
            -destination 'platform=iOS Simulator,name=iPhone 15 Pro,OS=17.0' \
            -configuration Release \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            ONLY_ACTIVE_ARCH=NO

  build-macos:
    name: Build macOS Release
    runs-on: macos-14
    needs: [test-ios, test-macos]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_15.0.app/Contents/Developer

      - name: Build macOS Release
        run: |
          xcodebuild clean build \
            -scheme NoteTaker \
            -sdk macosx \
            -destination 'platform=macOS' \
            -configuration Release \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            ONLY_ACTIVE_ARCH=NO

  status-check:
    name: All Checks Passed
    runs-on: macos-14
    needs: [lint, test-ios, test-macos, build-ios, build-macos]
    if: always()
    steps:
      - name: Check if all jobs succeeded
        run: |
          if [ "${{ needs.lint.result }}" != "success" ] || \
             [ "${{ needs.test-ios.result }}" != "success" ] || \
             [ "${{ needs.test-macos.result }}" != "success" ] || \
             [ "${{ needs.build-ios.result }}" != "success" ] || \
             [ "${{ needs.build-macos.result }}" != "success" ]; then
            echo "One or more checks failed"
            exit 1
          fi
          echo "All checks passed!"
