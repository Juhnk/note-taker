#!/bin/bash

# Pre-commit hook for NoteTaker (SIMPLIFIED FOR SPEED)
# Fast checks only (~30 seconds) - full validation happens in CI/CD
#
# Philosophy: "Maximum simplicity" means fast feedback loops
# - Pre-commit: Quick syntax and style checks
# - CI/CD: Full builds, tests, and coverage
#
# This approach maintains quality while supporting small 2-3 day cycles

set -e

echo "üîç Running pre-commit checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if Xcode project exists
if [ ! -d "NoteTaker.xcodeproj" ] && [ ! -d "NoteTaker.xcworkspace" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  Xcode project not found - skipping checks${NC}"
    echo "Pre-commit checks will be enforced once Xcode project is created"
    exit 0
fi

# 1. Run SwiftLint (fast: ~10 seconds)
echo ""
echo "üìù Running SwiftLint..."
if command -v swiftlint &> /dev/null; then
    if swiftlint lint --strict --quiet; then
        echo -e "${GREEN}‚úì SwiftLint passed${NC}"
    else
        echo -e "${RED}‚úó SwiftLint failed${NC}"
        echo "Fix linting errors before committing"
        echo "Run: swiftlint lint --strict"
        exit 1
    fi
else
    echo -e "${RED}‚úó SwiftLint not installed${NC}"
    echo "Please run: ./scripts/setup-hooks.sh"
    exit 1
fi

# 2. Check for debug print statements (fast: ~5 seconds)
echo ""
echo "üêõ Checking for debug print statements..."
STAGED_SWIFT_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep "\.swift$" || true)

if [ -n "$STAGED_SWIFT_FILES" ]; then
    FOUND_PRINTS=false
    while IFS= read -r file; do
        if [ -f "$file" ]; then
            if grep -n "print(" "$file" 2>/dev/null; then
                FOUND_PRINTS=true
                echo -e "${YELLOW}‚ö†Ô∏è  Warning: Found print() in $file${NC}"
            fi
        fi
    done <<< "$STAGED_SWIFT_FILES"

    if [ "$FOUND_PRINTS" = true ]; then
        echo ""
        echo "Debug print statements found. Remove them or continue anyway?"
        read -p "Continue? (y/n) " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            exit 1
        fi
    else
        echo -e "${GREEN}‚úì No debug print statements${NC}"
    fi
else
    echo -e "${GREEN}‚úì No Swift files to check${NC}"
fi

# 3. Quick syntax check (fast: ~15 seconds)
echo ""
echo "üîç Running quick syntax check..."
# Use -dry-run for fast syntax validation without full build
if xcodebuild -scheme NoteTaker \
    -sdk iphonesimulator \
    -destination 'platform=iOS Simulator,name=iPhone 15 Pro' \
    -dry-run \
    CODE_SIGN_IDENTITY="" \
    CODE_SIGNING_REQUIRED=NO \
    ONLY_ACTIVE_ARCH=YES \
    > /dev/null 2>&1; then
    echo -e "${GREEN}‚úì Syntax check passed${NC}"
else
    echo -e "${RED}‚úó Syntax errors detected${NC}"
    echo "Run full build to see details: xcodebuild -scheme NoteTaker build"
    exit 1
fi

echo ""
echo -e "${GREEN}========================================${NC}"
echo -e "${GREEN}‚úÖ Pre-commit checks passed!${NC}"
echo -e "${GREEN}========================================${NC}"
echo ""
echo "Fast checks completed in ~30 seconds"
echo "Full validation (builds, tests, coverage) will run in CI/CD"
echo ""
echo "CI/CD will:"
echo "  ‚úì Build iOS and macOS targets"
echo "  ‚úì Run all test suites"
echo "  ‚úì Check code coverage (progressive targets)"
echo "  ‚úì Block merge if any checks fail"
echo ""
echo -e "${GREEN}Proceeding with commit...${NC}"

exit 0
