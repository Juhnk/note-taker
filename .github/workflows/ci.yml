name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

# Use runner default Xcode (macos-15 → Xcode 16.4)
# No explicit DEVELOPER_DIR - uses latest available

jobs:
  lint:
    name: SwiftLint
    runs-on: macos-15
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install SwiftLint
        run: brew install swiftlint

      - name: Run SwiftLint
        run: swiftlint lint --strict

  test-ios:
    name: Test iOS
    runs-on: macos-15
    needs: lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check if Xcode project exists
        id: check_project
        run: |
          if [ ! -d "NoteTaker.xcodeproj" ] && [ ! -d "NoteTaker.xcworkspace" ]; then
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "⚠️  Xcode project not found - skipping build and test"
          else
            echo "exists=true" >> $GITHUB_OUTPUT
          fi

      - name: Show Xcode version
        if: steps.check_project.outputs.exists == 'true'
        run: xcodebuild -version

      - name: Build and test iOS
        if: steps.check_project.outputs.exists == 'true'
        run: |
          xcodebuild clean test \
            -scheme NoteTaker \
            -sdk iphonesimulator \
            -destination 'platform=iOS Simulator,name=iPhone 15 Pro' \
            -enableCodeCoverage YES \
            -derivedDataPath DerivedData \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            ONLY_ACTIVE_ARCH=NO

      - name: Generate code coverage report
        if: steps.check_project.outputs.exists == 'true'
        run: |
          xcrun xccov view --report --json DerivedData/Logs/Test/*.xcresult > coverage.json

      - name: Check code coverage
        if: steps.check_project.outputs.exists == 'true'
        run: |
          coverage=$(xcrun xccov view --report DerivedData/Logs/Test/*.xcresult | grep "NoteTaker.app" | awk '{print $4}' | sed 's/%//')
          echo "Code coverage: ${coverage}%"

          # Progressive coverage policy (see docs/TESTING.md)
          # Current phase: Sprint 0 - Coverage disabled
          # Sprint 1-2: 40%, Sprint 3-5: 50%, Sprint 6-9: 60%, Sprint 10+: 70%

          # Uncomment when Sprint 1 starts:
          # MIN_COVERAGE=40
          # if (( $(echo "$coverage < $MIN_COVERAGE" | bc -l) )); then
          #   echo "ERROR: Code coverage is below ${MIN_COVERAGE}% (got ${coverage}%)"
          #   exit 1
          # fi

          echo "✅ Coverage check disabled for Sprint 0 (empty project)"
          echo "Will enforce 40% minimum starting Sprint 1"

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        if: always() && steps.check_project.outputs.exists == 'true'
        with:
          name: ios-coverage
          path: coverage.json

  test-macos:
    name: Test macOS
    runs-on: macos-15
    needs: lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check if Xcode project exists
        id: check_project
        run: |
          if [ ! -d "NoteTaker.xcodeproj" ] && [ ! -d "NoteTaker.xcworkspace" ]; then
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "⚠️  Xcode project not found - skipping build and test"
          else
            echo "exists=true" >> $GITHUB_OUTPUT
          fi

      - name: Show Xcode version
        if: steps.check_project.outputs.exists == 'true'
        run: xcodebuild -version

      - name: Build and test macOS
        if: steps.check_project.outputs.exists == 'true'
        run: |
          xcodebuild clean test \
            -scheme NoteTaker \
            -sdk macosx \
            -destination 'platform=macOS' \
            -enableCodeCoverage YES \
            -derivedDataPath DerivedData \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            ONLY_ACTIVE_ARCH=NO

      - name: Generate code coverage report
        if: steps.check_project.outputs.exists == 'true'
        run: |
          xcrun xccov view --report --json DerivedData/Logs/Test/*.xcresult > coverage-macos.json

      - name: Check code coverage
        if: steps.check_project.outputs.exists == 'true'
        run: |
          coverage=$(xcrun xccov view --report DerivedData/Logs/Test/*.xcresult | grep "NoteTaker.app" | awk '{print $4}' | sed 's/%//')
          echo "Code coverage: ${coverage}%"

          # Progressive coverage policy (see docs/TESTING.md)
          # Current phase: Sprint 0 - Coverage disabled
          # Sprint 1-2: 40%, Sprint 3-5: 50%, Sprint 6-9: 60%, Sprint 10+: 70%

          # Uncomment when Sprint 1 starts:
          # MIN_COVERAGE=40
          # if (( $(echo "$coverage < $MIN_COVERAGE" | bc -l) )); then
          #   echo "ERROR: Code coverage is below ${MIN_COVERAGE}% (got ${coverage}%)"
          #   exit 1
          # fi

          echo "✅ Coverage check disabled for Sprint 0 (empty project)"
          echo "Will enforce 40% minimum starting Sprint 1"

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        if: always() && steps.check_project.outputs.exists == 'true'
        with:
          name: macos-coverage
          path: coverage-macos.json

  build-ios:
    name: Build iOS Release
    runs-on: macos-15
    needs: [test-ios, test-macos]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check if Xcode project exists
        id: check_project
        run: |
          if [ ! -d "NoteTaker.xcodeproj" ] && [ ! -d "NoteTaker.xcworkspace" ]; then
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "⚠️  Xcode project not found - skipping build"
          else
            echo "exists=true" >> $GITHUB_OUTPUT
          fi

      - name: Build iOS Release
        if: steps.check_project.outputs.exists == 'true'
        run: |
          xcodebuild clean build \
            -scheme NoteTaker \
            -sdk iphonesimulator \
            -destination 'platform=iOS Simulator,name=iPhone 15 Pro' \
            -configuration Release \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            ONLY_ACTIVE_ARCH=NO

  build-macos:
    name: Build macOS Release
    runs-on: macos-15
    needs: [test-ios, test-macos]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check if Xcode project exists
        id: check_project
        run: |
          if [ ! -d "NoteTaker.xcodeproj" ] && [ ! -d "NoteTaker.xcworkspace" ]; then
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "⚠️  Xcode project not found - skipping build"
          else
            echo "exists=true" >> $GITHUB_OUTPUT
          fi

      - name: Build macOS Release
        if: steps.check_project.outputs.exists == 'true'
        run: |
          xcodebuild clean build \
            -scheme NoteTaker \
            -sdk macosx \
            -destination 'platform=macOS' \
            -configuration Release \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            ONLY_ACTIVE_ARCH=NO

  status-check:
    name: All Checks Passed
    runs-on: macos-15
    needs: [lint, test-ios, test-macos, build-ios, build-macos]
    if: always()
    steps:
      - name: Check if all jobs succeeded
        run: |
          if [ "${{ needs.lint.result }}" != "success" ] || \
             [ "${{ needs.test-ios.result }}" != "success" ] || \
             [ "${{ needs.test-macos.result }}" != "success" ] || \
             [ "${{ needs.build-ios.result }}" != "success" ] || \
             [ "${{ needs.build-macos.result }}" != "success" ]; then
            echo "One or more checks failed"
            exit 1
          fi
          echo "✅ All checks passed!"
